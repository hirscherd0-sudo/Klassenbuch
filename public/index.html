<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klassenbuch Git</title>
    
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        [v-cloak] { display: none !important; }
        body { font-family: sans-serif; background-color: #f8fafc; color: #1e293b; }
        .glass-panel { background: white; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .toggle-checkbox:checked { right: 0; border-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #0f172a; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .pdf-visible-mode { position: fixed !important; top: 0; left: 0; width: 100vw; height: 100vh; background: white; z-index: 99999; overflow: auto; padding: 20px; display: block !important; }
    </style>
</head>
<body>

<div id="loading-screen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; align-items:center; justify-content:center;">
    <div style="text-align:center;">
        <div id="spinner" class="loader"></div>
        <p id="loading-text">Verbinde mit GitHub...</p>
    </div>
</div>

<script>
    setTimeout(function() {
        if (typeof Vue === 'undefined') document.getElementById('loading-text').innerText = 'Fehler: Bibliotheken blockiert.';
    }, 4000);
</script>

<div id="app" v-cloak class="min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav v-if="view !== 'login'" class="bg-white border-b border-slate-200 sticky top-0 z-50 h-16 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 h-full flex justify-between items-center">
            <div class="flex items-center gap-4">
                <button v-if="view !== 'calendar'" @click="goBack" class="p-2 text-slate-500 hover:bg-slate-100 rounded-full transition">
                    <span v-if="!iconsLoaded">&larr;</span><i v-else data-lucide="arrow-left"></i>
                </button>
                <span class="font-bold text-lg tracking-tight">Klassenbuch <span class="text-slate-400 font-normal">Git</span></span>
            </div>
            
            <div class="flex items-center gap-3">
                <!-- Status Anzeige -->
                <div class="text-xs font-bold px-3 py-1 rounded transition-colors"
                     :class="{
                         'bg-slate-100 text-slate-500': saveStatus === 'idle',
                         'bg-blue-100 text-blue-600': saveStatus === 'saving',
                         'bg-green-100 text-green-600': saveStatus === 'success',
                         'bg-red-100 text-red-600 cursor-pointer': saveStatus === 'error'
                     }"
                     @click="saveStatus === 'error' ? alert(lastError) : null">
                    <span v-if="saveStatus === 'idle'">Bereit</span>
                    <span v-if="saveStatus === 'saving'" class="flex gap-1"><span class="animate-spin">⟳</span> GitHub...</span>
                    <span v-if="saveStatus === 'success'">Gespeichert</span>
                    <span v-if="saveStatus === 'error'">FEHLER!</span>
                </div>

                <span class="px-3 py-1 text-xs font-bold uppercase rounded-full tracking-wider"
                      :class="role === 'admin' ? 'bg-slate-800 text-white' : 'bg-emerald-100 text-emerald-700'">
                    {{ role === 'admin' ? 'Administrator' : 'Gast' }}
                </span>
                <button @click="logout" class="ml-2 text-slate-400 hover:text-red-500 transition">
                    <i v-if="iconsLoaded" data-lucide="log-out"></i><span v-else>Exit</span>
                </button>
            </div>
        </div>
    </nav>

    <main class="flex-grow flex flex-col items-center p-6 w-full max-w-7xl mx-auto">
        <!-- LOGIN -->
        <div v-if="view === 'login'" class="flex flex-col items-center justify-center h-[80vh] w-full">
            <div class="glass-panel p-10 rounded-2xl w-full max-w-sm text-center">
                <div class="mb-6 flex justify-center">
                    <div class="bg-slate-900 text-white p-3 rounded-xl shadow-lg">
                        <i v-if="iconsLoaded" data-lucide="github" width="24"></i><span v-else>G</span>
                    </div>
                </div>
                <h1 class="text-2xl font-bold mb-2">Login</h1>
                <form @submit.prevent="handleLogin">
                    <div class="mb-4 text-left">
                        <input type="password" v-model="password" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-slate-800 outline-none transition" placeholder="Passwort...">
                    </div>
                    <button type="submit" class="w-full bg-slate-900 hover:bg-slate-800 text-white py-3 rounded-lg font-bold transition shadow-md">Starten</button>
                </form>
                <p v-if="error" class="mt-4 text-sm text-red-600 font-medium">{{ error }}</p>
            </div>
        </div>

        <!-- CALENDAR -->
        <div v-else-if="view === 'calendar'" class="w-full max-w-6xl mt-6">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h2 class="text-2xl font-bold">Wochenübersicht</h2>
                    <p class="text-slate-500 text-sm">Daten aus GitHub: {{ repoName || 'Lädt...' }}</p>
                </div>
                <div class="flex bg-white rounded border border-slate-200">
                    <button @click="changeWeek(-1)" class="px-3 py-2 hover:bg-slate-50 border-r">&lt;</button>
                    <div class="px-4 py-2 text-sm font-mono flex items-center bg-slate-50 text-slate-600">{{ getWeekLabel() }}</div>
                    <button @click="changeWeek(1)" class="px-3 py-2 hover:bg-slate-50 border-l">&gt;</button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
                <div v-for="(date, index) in currentWeek" :key="date" @click="selectDay(date)" class="glass-panel p-6 rounded-xl cursor-pointer hover:border-blue-500 hover:shadow-md transition h-36 flex flex-col justify-between group">
                    <span class="text-xs font-bold uppercase text-slate-400">{{ ['Mo', 'Di', 'Mi', 'Do', 'Fr'][index] }}</span>
                    <span class="text-2xl font-bold text-slate-800 group-hover:text-blue-600">{{ formatDateDay(date) }}<span class="text-sm font-normal text-slate-400 block">{{ formatDateMonth(date) }}</span></span>
                    <div class="text-right opacity-0 group-hover:opacity-100 transition text-blue-500">&rarr;</div>
                </div>
            </div>
            <div v-if="role === 'admin'" class="text-center pt-8 border-t border-slate-200">
                <button @click="generateMatrixPDF" :disabled="generatingPdf" class="bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-6 py-3 rounded-lg font-medium shadow-sm inline-flex items-center gap-2 disabled:opacity-50">
                    <span v-if="generatingPdf" class="animate-spin">⟳</span>
                    <span>{{ generatingPdf ? 'Erstelle PDF...' : 'Wochenbericht PDF (A4 Quer)' }}</span>
                </button>
            </div>
        </div>

        <!-- PERIODS -->
        <div v-else-if="view === 'periods'" class="w-full max-w-4xl mt-8 text-center">
            <h2 class="text-3xl font-bold mb-2">{{ getDayName(selectedDate) }}</h2>
            <p class="text-slate-500 mb-10">{{ formatDateFull(selectedDate) }}</p>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <button v-for="i in 8" :key="i" @click="selectPeriod(i)" class="glass-panel aspect-square rounded-xl flex flex-col items-center justify-center hover:scale-105 hover:border-blue-500 hover:shadow-lg transition cursor-pointer group">
                    <span class="text-4xl font-black text-slate-200 group-hover:text-blue-600 transition mb-2">{{ i }}</span>
                    <span class="text-xs font-bold uppercase text-slate-400">Stunde</span>
                </button>
            </div>
        </div>

        <!-- LIST -->
        <div v-else-if="view === 'list'" class="w-full max-w-5xl mt-4">
            <div class="glass-panel rounded-xl overflow-hidden">
                <div class="px-6 py-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                    <div>
                        <span class="text-xs font-bold uppercase text-blue-600 tracking-wider block mb-1">{{ selectedPeriod }}. Stunde</span>
                        <h2 class="text-xl font-bold text-slate-800">Anwesenheit</h2>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold">{{ students.filter(s => s.present).length }} <span class="text-slate-400 text-lg">/ {{ students.length }}</span></div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-white border-b border-slate-100 text-slate-400 text-xs font-bold uppercase tracking-wider">
                                <th class="px-6 py-3">Name</th>
                                <th class="px-6 py-3 text-center">Anwesend</th>
                                <th class="px-6 py-3">Anmerkung</th>
                                <th v-if="role === 'admin'" class="px-4 py-3"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">
                            <tr v-for="(student, index) in students" :key="student.id" class="hover:bg-slate-50 transition">
                                <td class="px-6 py-3 font-medium">
                                    <input v-if="role === 'admin'" type="text" v-model="student.name" @change="debouncedSave" class="bg-transparent outline-none w-full">
                                    <span v-else>{{ student.name }}</span>
                                </td>
                                <td class="px-6 py-3 flex justify-center">
                                    <div class="relative inline-block w-10 h-6 align-middle select-none">
                                        <!-- CHECKBOX: Speichert sofort (saveNow) ohne Verzögerung -->
                                        <input type="checkbox" :id="'toggle-'+index" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer" style="top:4px; left:4px; transition: all 0.3s;" v-model="student.present" @change="saveNow">
                                        <label :for="'toggle-'+index" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer transition-colors" :class="{'bg-emerald-500': student.present}"></label>
                                    </div>
                                </td>
                                <td class="px-6 py-3">
                                    <!-- INPUT: Speichert verzögert (debouncedSave) -->
                                    <input type="text" v-model="student.note" @change="debouncedSave" :placeholder="(!student.present && !student.note) ? 'UNGEKLÄRT' : 'Anmerkung...'" :class="{'bg-red-50 text-red-600 placeholder-red-500 font-bold border-red-200': !student.present && !student.note, 'bg-white text-slate-600 border-transparent focus:border-slate-300': student.present || student.note}" class="w-full text-sm rounded border px-3 py-2 outline-none transition-colors">
                                </td>
                                <td v-if="role === 'admin'" class="px-4 py-3 text-center">
                                    <button @click="removeStudent(index)" class="text-slate-300 hover:text-red-500"><i v-if="iconsLoaded" data-lucide="trash-2" width="16"></i><span v-else>X</span></button>
                                </td>
                            </tr>
                            <tr v-if="students.length === 0">
                                <td colspan="4" class="px-6 py-8 text-center text-slate-400 italic">Keine Einträge.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div v-if="role === 'admin'" class="bg-slate-50 px-6 py-3 border-t border-slate-200 flex gap-2">
                    <input type="text" v-model="newStudentName" placeholder="Neuer Schüler..." class="flex-1 border border-slate-300 rounded px-3 py-2 text-sm outline-none focus:border-slate-800">
                    <button @click="addStudent" class="bg-slate-800 text-white px-4 py-2 rounded text-sm font-bold hover:bg-slate-700">Hinzufügen</button>
                </div>
            </div>
        </div>
    </main>

    <!-- PDF TEMPLATE -->
    <div id="pdf-container" style="display: none;">
        <div style="font-family: Arial, sans-serif; padding: 20px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:2px solid #000; padding-bottom:10px;">
                <div><h1 style="font-size: 24px; margin:0;">Wochenbericht Anwesenheit</h1><p style="font-size: 14px; margin:5px 0 0 0; color: #555;">Klasse / Kurs</p></div>
                <div style="text-align:right;"><h2 style="font-size: 16px; margin:0;">{{ getWeekLabel() }}</h2><p style="font-size: 10px; color:#999;">Erstellt am: {{ new Date().toLocaleDateString() }}</p></div>
            </div>
            <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                <thead><tr><th style="border: 1px solid #333; padding: 5px; background: #eee; text-align: left; width: 150px;">Name</th><template v-for="d in ['Mo','Di','Mi','Do','Fr']"><th v-for="p in 8" style="border: 1px solid #999; text-align: center; width: 20px; background: #f9f9f9; padding: 2px;">{{d}}{{p}}</th></template></tr></thead>
                <tbody><tr v-for="s in matrixData" :key="s.name"><td style="border: 1px solid #333; padding: 4px; font-weight: bold;">{{ s.name }}</td><template v-for="dIdx in 5"><td v-for="p in 8" :style="{border: '1px solid #ccc', backgroundColor: getMatrixColor(s, dIdx-1, p), height: '18px'}"></td></template></tr></tbody>
            </table>
            <div style="margin-top: 20px; font-size: 10px; display:flex; gap:15px;">
                <div style="display:flex; align-items:center;"><span style="display:inline-block; width:12px; height:12px; background:#86efac; border:1px solid #333; margin-right:5px;"></span>Anwesend</div>
                <div style="display:flex; align-items:center;"><span style="display:inline-block; width:12px; height:12px; background:#fca5a5; border:1px solid #333; margin-right:5px;"></span>Abwesend</div>
                <div style="display:flex; align-items:center;"><span style="display:inline-block; width:12px; height:12px; background:white; border:1px solid #333; margin-right:5px;"></span>Keine Daten</div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    view: 'login', role: null, password: '', error: '',
                    weekOffset: 0, currentWeek: [], selectedDate: null, selectedPeriod: null,
                    students: [], newStudentName: '', matrixData: [], generatingPdf: false, iconsLoaded: false,
                    // NEU: Status Management
                    saveStatus: 'idle', // idle, saving, success, error
                    lastError: '',
                    repoName: '',
                    saveTimeout: null
                }
            },
            created() { this.updateWeek(); },
            mounted() {
                document.getElementById('loading-screen').style.display = 'none';
                if(typeof lucide !== 'undefined') { try { lucide.createIcons(); this.iconsLoaded = true; } catch(e){} }
            },
            updated() { if(typeof lucide !== 'undefined') { try { lucide.createIcons(); } catch(e){} } },
            methods: {
                handleLogin() {
                    if(this.password === 'Admin') { this.role = 'admin'; this.view = 'calendar'; }
                    else if(this.password === 'Gast') { this.role = 'guest'; this.view = 'calendar'; }
                    else { this.error = 'Falsches Passwort'; }
                    this.password = '';
                },
                logout() { this.role = null; this.view = 'login'; },
                goBack() { this.view = (this.view === 'list') ? 'periods' : 'calendar'; },
                updateWeek() {
                    const curr = new Date(); const day = curr.getDay();
                    const diff = curr.getDate() - day + (day === 0 ? -6 : 1) + (this.weekOffset * 7);
                    const monday = new Date(curr.setDate(diff));
                    this.currentWeek = [];
                    for(let i=0; i<5; i++) { const d = new Date(monday); d.setDate(monday.getDate() + i); this.currentWeek.push(d.toISOString().split('T')[0]); }
                },
                changeWeek(delta) { this.weekOffset += delta; this.updateWeek(); },
                getWeekLabel() { if(!this.currentWeek.length) return ''; const s = this.currentWeek[0].split('-'); const e = this.currentWeek[4].split('-'); return `${s[2]}.${s[1]}. - ${e[2]}.${e[1]}.`; },
                selectDay(d) { this.selectedDate = d; this.view = 'periods'; },
                selectPeriod(p) { this.selectedPeriod = p; this.fetchData(); this.view = 'list'; },
                
                async fetchData() {
                    this.saveStatus = 'idle';
                    try { const res = await fetch(`/api/attendance/${this.selectedDate}/${this.selectedPeriod}`); this.students = await res.json(); } catch(e) { this.students = []; }
                },
                
                debouncedSave() {
                    if(this.saveTimeout) clearTimeout(this.saveTimeout);
                    this.saveStatus = 'saving';
                    this.saveTimeout = setTimeout(() => this.saveNow(), 1500); 
                },
                
                async saveNow() {
                    if(this.saveTimeout) clearTimeout(this.saveTimeout);
                    this.saveStatus = 'saving';
                    try { 
                        const res = await fetch('/api/attendance', { 
                            method: 'POST', 
                            headers: {'Content-Type':'application/json'}, 
                            body: JSON.stringify({ date: this.selectedDate, period: this.selectedPeriod, list: this.students }) 
                        });
                        const data = await res.json();
                        if(data.error) throw new Error(data.error);
                        
                        this.saveStatus = 'success';
                        setTimeout(() => { if(this.saveStatus === 'success') this.saveStatus = 'idle'; }, 2000);
                    } catch(e) { 
                        this.saveStatus = 'error'; 
                        this.lastError = e.message;
                    }
                },
                
                addStudent() { if(!this.newStudentName.trim()) return; this.students.push({ id: Date.now(), name: this.newStudentName, present: true, note: '' }); this.newStudentName = ''; this.students.sort((a,b)=>a.name.localeCompare(b.name)); this.saveNow(); },
                removeStudent(i) { if(confirm('Löschen?')) { this.students.splice(i,1); this.saveNow(); } },
                
                async generateMatrixPDF() {
                    this.generatingPdf = true;
                    try {
                        const res = await fetch('/api/matrix', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ weekDates: this.currentWeek }) });
                        this.matrixData = await res.json();
                        await new Promise(r => setTimeout(r, 200));
                        const element = document.getElementById('pdf-container');
                        element.classList.add('pdf-visible-mode');
                        const opt = { margin: 10, filename: `Wochenbericht_${this.currentWeek[0]}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } };
                        await html2pdf().set(opt).from(element).save();
                        element.classList.remove('pdf-visible-mode');
                    } catch(e) { alert('Fehler: ' + e.message); } finally { this.generatingPdf = false; }
                },
                getMatrixColor(s, dIdx, p) { const key = `${dIdx}_${p}`; const val = s.slots[key]; if(val === true) return '#86efac'; if(val === false) return '#fca5a5'; return 'white'; },
                formatDateDay(d) { return d.split('-')[2]; },
                formatDateMonth(d) { return new Date(d).toLocaleDateString('de-DE',{month:'long'}); },
                formatDateFull(d) { return new Date(d).toLocaleDateString('de-DE',{dateStyle:'full'}); },
                getDayName(d) { return new Date(d).toLocaleDateString('de-DE',{weekday:'long'}); }
            }
        }).mount('#app');
    });
</script>
</body>
</html>


